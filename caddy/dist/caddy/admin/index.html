<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>系统重启</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes pulse-scale {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .animate-pulse-scale {
        animation: pulse-scale 1s infinite;
      }
    </style>
  </head>
  <body
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 via-purple-500 to-purple-700"
  >
    <div class="bg-white rounded-3xl shadow-2xl p-12 text-center max-w-md w-11/12">
      <div id="initialState">
        <h1 class="text-3xl font-semibold mb-8 text-gray-800">系统控制面板</h1>
        <button
          id="restartBtn"
          class="bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold text-xl px-10 py-5 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none min-w-[200px]"
        >
          <span id="btnText">重启系统</span>
        </button>
        <div
          id="errorMessage"
          class="hidden mt-5 bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-lg"
        ></div>
      </div>

      <div id="countdownState" class="hidden">
        <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-5">重启请求发送成功！</div>
        <div class="text-lg mb-5 text-gray-800">系统将在以下时间后自动跳转：</div>
        <div id="countdownNumber" class="text-6xl font-bold text-red-500 my-5 animate-pulse-scale">5</div>
        <div class="text-gray-500 text-sm">请稍等，正在准备跳转...</div>
      </div>
    </div>

    <script>
      class RestartController {
        constructor() {
          this.restartBtn = document.getElementById("restartBtn");
          this.btnText = document.getElementById("btnText");
          this.errorMessage = document.getElementById("errorMessage");
          this.initialState = document.getElementById("initialState");
          this.countdownState = document.getElementById("countdownState");
          this.countdownNumber = document.getElementById("countdownNumber");

          this.bindEvents();
        }

        bindEvents() {
          this.restartBtn.addEventListener("click", () => this.handleRestart());
        }

        async handleRestart() {
          try {
            this.setLoadingState();
            await this.sendRestartRequest();
            this.startCountdown();
          } catch (error) {
            this.showError(error.message);
            this.resetToInitialState();
          }
        }

        setLoadingState() {
          this.restartBtn.disabled = true;
          this.btnText.innerHTML = '<span class="loading"></span>发送重启请求...';
          this.hideError();
        }

        async sendRestartRequest() {
          const response = await fetch("/admin/shutdown", {
            signal: AbortSignal.timeout(10000),
          });

          if (!response.ok) {
            const errorText = await response.text().catch(() => "未知错误");
            throw new Error(`请求失败 (${response.status}): ${errorText}`);
          }

          return response;
        }

        startCountdown() {
          this.initialState.style.display = "none";
          this.countdownState.style.display = "block";

          let count = 5;
          this.countdownNumber.textContent = count;

          const timer = setInterval(() => {
            count--;
            this.countdownNumber.textContent = count;

            if (count <= 0) {
              clearInterval(timer);
              window.location.href = "/";
            }
          }, 1000);
        }

        showError(message) {
          this.errorMessage.textContent = message;
          this.errorMessage.style.display = "block";
        }

        hideError() {
          this.errorMessage.style.display = "none";
        }

        resetToInitialState() {
          this.restartBtn.disabled = false;
          this.btnText.textContent = "重启系统";
          this.initialState.style.display = "block";
          this.countdownState.style.display = "none";
        }
      }

      // 初始化应用
      document.addEventListener("DOMContentLoaded", () => {
        new RestartController();
      });

      // 处理页面可见性变化，避免在后台时继续倒计时
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          // 页面隐藏时可以添加额外逻辑
        }
      });
    </script>
  </body>
</html>
